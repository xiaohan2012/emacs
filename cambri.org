* strings in clipboard

#+begin_src emacs-lisp

  (defun cambri/aws-account-number ()
    (interactive)
    (kill-new "503935936293")
    (message "copid '503935936293'")
    )
#+end_src

#+RESULTS:
: cambri/aws-account-number
* dbt

#+begin_src emacs-lisp
  (defvar cambri/dbt/modes (list "itself" "ancestors" "descendents") "the list of model types by traffic")

  (defun cambri/dbt-run-model ()
    "Run a dbt model."
    (interactive)  
    (let* ((buffer-name "*DBT execution")
           (sql-files (seq-filter
                       (lambda (filename) (string-suffix-p ".sql" filename))
                       (append
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/curated/survey_results_kpi/")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/intermediate/app/survey_results/kpi/")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/intermediate/app/scale_kpi/")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/intermediate/app/launch_ai/")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/curated/launch_ai/")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/intermediate/app")
                        (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/tests/curated/launch_ai_v2/")
                        ;; (directory-files "/Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt/models/intermediate/app/top2box_kpi/")
                        )))
           (raw-model-name (completing-read "DBT model: " (mapcar (lambda (filename) (s-chop-suffix ".sql" filename)) sql-files)))
           (mode (completing-read "Mode: " cambri/dbt/modes nil nil "itself"))
           (model-name (cond
                        ((string= mode "itself") raw-model-name)
                        ((string= mode "ancestors") (concat "+" raw-model-name))
                        ((string= mode "descendents") (concat raw-model-name "+"))
                        (t nil)))
           )
      (shell buffer-name)
      (end-of-buffer)
      (insert "pyenv deactivate\n")
      (comint-send-input)    
      (insert "pyenv activate dbt\n")
      (comint-send-input)
      (insert "cd /Users/hanxiao/code/monolith/analytics/datalake/ecs/dbt\n")
      (comint-send-input)
      (insert (format "dbt run --profiles-dir profile --vars '{execution_date: 2023/09/26}' --select %s" model-name))
      (comint-send-input) ;; Send the input to the shell process  
      (display-buffer buffer-name)
      )
    )
#+end_src

#+RESULTS:
: cambri/dbt-run-model
* launchai-v2
** train locally
#+begin_src emacs-lisp
  (defun cambri/laiv2-train ()
    "Open the project shell and trigger the pipeline."
    (interactive)
    (project-shell)
    (insert "caffeinate -i python modules/metaflow_pipeline.py run\n")
    (comint-send-input)    
  )
#+end_src

#+RESULTS:
: cambri/laiv2-train

** submit job to claude

#+begin_src emacs-lisp
  (defun cambri/laiv2-submit-to-cloud ()
    "Open the project shell and trigger the pipeline on the cloud."
    (interactive)
    (project-shell)
    (insert "python modules/metaflow_pipeline.py step-functions create\n")
    (insert "python modules/metaflow_pipeline.py step-functions trigger\n")
    (comint-send-input)    
  )
#+end_src

#+RESULTS:
: cambri/laiv2-submit-to-cloud

* git related

#+begin_src emacs-lisp
    
  (defun cambri/git-submodule-update ()
    "Open the project shell and run 'git submodule update --init --recursive'."
    (interactive)
    (project-shell)
    (insert "git submodule update --init --recursive\n")
    (comint-send-input)    
  )

#+end_src

#+RESULTS:
: cambri/git-submodule-update

* claude-code

#+begin_src emacs-lisp
  ;; (setenv "CLAUDE_CODE_USE_BEDROCK" "1")
  ;; (setenv "ANTHROPIC_MODEL" "eu.anthropic.claude-sonnet-4-20250514-v1:0")
  (setenv "AWS_DEFAULT_REGION" "eu-west-1")
  (setenv "AWS_PROFILE" "DSDEV")
#+end_src

#+RESULTS:
: DSDEV

* ruff

*** flycheck-ruff

#+begin_src emacs-lisp
(use-package flymake-ruff
  :ensure t
  :hook (python-mode . flymake-ruff-load))
#+end_src

#+RESULTS:
| flymake-ruff-load | ruff-format-on-save-mode | elpy-mode | #[nil ((lsp-mode 1) (flycheck-mode nil)) nil] |


*** ruff formatting (on file save)

#+begin_src emacs-lisp
  (use-package reformatter
    :ensure t    
    :hook 
    (python-mode . ruff-format-on-save-mode)
    (python-ts-mode . ruff-format-on-save-mode)
    :config
    (reformatter-define ruff-format
      :program "ruff"
      :args `("format" "--config" "~/code/service-launch-ai/code/pyproject.toml" "--stdin-filename" ,buffer-file-name "-")))
#+end_src

#+RESULTS:
| ruff-format-on-save-mode |

* escape character filtering

- related to pytest output in terminal
- https://claude.ai/chat/acb68c2c-5b9f-481d-aa3a-2283e46076a6

#+begin_src emacs-lisp
  (defun filter-osc-9-4-compile ()
    "Filter out OSC 9;4 escape sequences and all stray backslashes."
    (save-excursion
      ;; First pass: remove OSC sequences
      (goto-char compilation-filter-start)
      (while (search-forward "]9;4;" nil t)
        (let ((start (- (point) 6)))
          (when (re-search-forward "[^\\]*\\\\" nil t)
            (delete-region start (point)))))
      ;; Second pass: remove any remaining backslashes that shouldn't be there
      ;; This handles \=, \., and trailing backslashes
      (goto-char compilation-filter-start)
      (while (re-search-forward "\\\\\\([.=:\n]\\|$\\)" nil t)
        (replace-match "\\1"))))

  (remove-hook 'compilation-filter-hook 'filter-osc-9-4-compile)
  (add-hook 'compilation-filter-hook 'filter-osc-9-4-compile)
#+end_src

#+RESULTS:
| filter-osc-9-4-compile |

